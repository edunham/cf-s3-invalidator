#!/usr/bin/env ruby
require 'optparse'
require File.dirname(__FILE__)+'/../lib/cloudfront_invalidator'
require File.dirname(__FILE__)+'/../lib/s3_loader'

options = {}
optparse = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename(__FILE__)} [options]"
  opts.separator ""
  opts.separator "Invalidate an S3-based Cloudfront distribution"
  opts.separator ""
  opts.separator "Options:"
  opts.on("-k", "--key AWS KEY",
          "Amazon Web Services API key that has access to your S3 and Cloudfront") do |val|
    options[:key] = val
  end
  opts.on("-s", "--secret AWS SECRET",
          "Amazon Web Services API secret key") do |val|
    options[:secret] = val
  end
  opts.on("-b", "--bucket BUCKET NAME",
          "S3 bucket name") do |val|
    options[:bucket] = val
  end
  opts.on("-d", "--distribution CLOUDFRONT ID",
          "Cloudfront distribution id") do |val|
    options[:distribution] = val
  end
end

ARGV_ORIGINAL = ARGV.dup
optparse.parse!
if ARGV_ORIGINAL.length == 0
  puts optparse.help
  exit
end

s3_object_keys = S3Loader.new(
  options[:key], options[:secret]).list_keys(options[:bucket])

invalidator = CloudfrontInvalidator.new(
  options[:key], options[:secret], options[:distribution])
invalidator.invalidate(s3_object_keys)
